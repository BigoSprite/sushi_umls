
@startuml
'https://plantuml.com/sequence-diagram

autonumber

==离线推理 - 单进程同步==
actor User
User -[#green]> LLM: <color red>**prompts**</color>: str[]\n提示词序列
activate LLM
LLM -[#blue]> LLM: generate()
LLM --> LLM: _validate_and_add_requests()

activate LLMEngine

note over LLM
Continuous batching of incoming requests
end note

loop i=1..len(prompts)
LLM o-[#blue]> LLMEngine: \tllm_engine.add_request()

LLMEngine --> LLMEngine: processor.process_inputs()-><color red>**EngineCoreRequest**</color>
LLMEngine o-> InprocClient: \tengine_core.add_request()
activate EngineCore
activate InprocClient
InprocClient o-> EngineCore: \tengine_core.add_request()
EngineCore --> EngineCore: Request.from_engine_core_request()-><color red>**Request**</color>
activate Scheduler
EngineCore o-> Scheduler: \tscheduler.add_request()
Scheduler --> Scheduler: waiting.append()
end

LLM --> LLM: _run_engine()
loop llm_engine.has_unfinished_requests()
LLM o-[#blue]> LLMEngine: \tllm_engine.step()->step_outputs
LLMEngine o-> InprocClient: \tengine_core.get_output()->EngineCoreOutputs
InprocClient o-> EngineCore: \tengine_core.step()->EngineCoreOutputs
EngineCore o-> Scheduler: \tscheduler.schedule()->SchedulerOutput
EngineCore o-> UniProcExecutor: \tmodel_executor.execute_model(SchedulerOutput)-><color red>**ModelRunnerOutput**</color>
activate UniProcExecutor
UniProcExecutor --> UniProcExecutor: collective_rpc("execute_model")
UniProcExecutor --> UniProcExecutor: run_method(self.driver_worker, "execute_model")\n->answer:ModelRunnerOutput
UniProcExecutor o-> WorkerWrapperBase: driver_worker.execute_model()
EngineCore o-> Scheduler: \tschedule.update_from_output(SchedulerOutput,ModelRunnerOutput)->EngineCoreOutputs
Scheduler --> LLMEngine: \t<color red>**EngineCoreOutputs**</color>

LLMEngine --> LLMEngine: output_processor.process_outputs(EngineCoreOutputs.outputs)\n.request_outputs->\nstep_outputs:list[RequestOutput]
LLMEngine --> LLM: \tstep_outputs


loop output in step_outputs
LLM --> LLM: outputs.append(output)
end
end
LLM -[#green]-> User: return sorted(outputs): list[<color red>**RequestOutput**</color>]

deactivate UniProcExecutor
deactivate Scheduler
deactivate EngineCore
deactivate LLMEngine
deactivate LLM

@enduml
